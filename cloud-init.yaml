#cloud-config
write_files:
  - path: /opt/wireguard/setup-wg.sh
    content: |
      #!/bin/bash
      # Get public IP from Yandex Cloud metadata service
      PUBLIC_IP=$(curl -s http://169.254.169.254/latest/metadata/v4/instance/network-interfaces/0/external-ip || curl -s ifconfig.me)
      
      # Create docker-compose.yml with dynamic IP
      cat > /opt/wireguard/docker-compose.yml <<EOF
      version: '3.8'
      services:
        wg-easy:
          environment:
            - WG_HOST=$PUBLIC_IP
            - PASSWORD=${wg_easy_password}
            - WG_ALLOWED_IPS=0.0.0.0/0
            - WG_DEFAULT_ADDRESS=10.8.0.x
            - WG_DEFAULT_DNS=1.1.1.1
            - WG_MTU=1420
            - WG_PORT=51820
            - WG_PERSISTENT_KEEPALIVE=25
          image: weejewel/wg-easy
          container_name: wg-easy
          cap_add:
            - NET_ADMIN
            - SYS_MODULE
          sysctls:
            - net.ipv4.ip_forward=1
            - net.ipv4.conf.all.src_valid_mark=1
          volumes:
            - /opt/wireguard/wg-data:/etc/wireguard
          ports:
            - "51820:51820/udp"
            - "51821:51821/tcp"
          restart: unless-stopped
      EOF
      
      # Start Docker Compose
      cd /opt/wireguard && docker compose up -d
      
      echo "WireGuard VPN server started with IP: $PUBLIC_IP"
    owner: root:root
    permissions: '0755'

runcmd:
  # Update system
  - apt-get update
  - apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release

  # Install Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

  # Enable IPv4 forwarding
  - sysctl -w net.ipv4.ip_forward=1
  - echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf

  # Create wireguard directory
  - mkdir -p /opt/wireguard/wg-data

  # Wait for network interface to get public IP
  - sleep 15

  # Run setup script to get IP and start WireGuard
  - /opt/wireguard/setup-wg.sh

  # Show status
  - sleep 5
  - docker ps
  - echo "WireGuard VPN server setup complete!"

